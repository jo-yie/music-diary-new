<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Playback</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #1DB954;
        }
        .player-container {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        button {
            background-color: #1DB954;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background-color: #1ed760;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .track-info {
            margin-top: 20px;
        }
        .status {
            margin-top: 10px;
            font-style: italic;
            color: #666;
        }
        .start-playback {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Spotify Playback</h1>
    
    <div class="player-container">
        <div class="status" id="connection-status">Connecting to Spotify...</div>
        
        <div class="track-info" id="track-info">
            <p>No track playing</p>
        </div>
        
        <div class="controls">
            <button id="previous-button" disabled>Previous</button>
            <button id="play-button" disabled>Play</button>
            <button id="next-button" disabled>Next</button>
        </div>
        
        <div class="start-playback" id="start-playback" style="display: none;">
            <p>No active playback detected. Start playing something on Spotify first.</p>
            <button id="start-playback-button">Start Playback</button>
        </div>
    </div>

    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script th:inline="javascript">
        window.onSpotifyWebPlaybackSDKReady = () => {
            // Get the access token from Thymeleaf
            const token = /*[[${accessToken}]]*/ '';
            let deviceId = null;
            
            // Initialize the player
            const player = new Spotify.Player({
                name: 'Web Playback SDK Player',
                getOAuthToken: cb => { cb(token); },
                volume: 0.5
            });
            
            // Error handling
            player.addListener('initialization_error', ({ message }) => {
                console.error('Failed to initialize:', message);
                document.getElementById('connection-status').textContent = 'Failed to initialize: ' + message;
            });
            
            player.addListener('authentication_error', ({ message }) => {
                console.error('Failed to authenticate:', message);
                document.getElementById('connection-status').textContent = 'Authentication failed: ' + message;
            });
            
            player.addListener('account_error', ({ message }) => {
                console.error('Premium required:', message);
                document.getElementById('connection-status').textContent = 'Premium account required for playback';
            });
            
            player.addListener('playback_error', ({ message }) => {
                console.error('Failed to perform playback:', message);
                document.getElementById('connection-status').textContent = 'Playback error: ' + message;
            });
            
            // Ready
            player.addListener('ready', ({ device_id }) => {
                console.log('Ready with Device ID', device_id);
                deviceId = device_id;
                document.getElementById('connection-status').textContent = 'Connected to Spotify! Device ready.';
                
                // Enable the controls
                document.getElementById('play-button').disabled = false;
                document.getElementById('previous-button').disabled = false;
                document.getElementById('next-button').disabled = false;
                
                // Make this device the active one
                transferPlayback(device_id);
            });
            
            // Not Ready
            player.addListener('not_ready', ({ device_id }) => {
                console.log('Device has gone offline', device_id);
                document.getElementById('connection-status').textContent = 'Device disconnected';
                
                // Disable the controls
                document.getElementById('play-button').disabled = true;
                document.getElementById('previous-button').disabled = true;
                document.getElementById('next-button').disabled = true;
            });
            
            // State changes
            player.addListener('player_state_changed', (state) => {
                console.log('Player state changed', state);
                
                if (!state) {
                    document.getElementById('track-info').innerHTML = '<p>No track playing</p>';
                    document.getElementById('start-playback').style.display = 'block';
                    return;
                }
                
                document.getElementById('start-playback').style.display = 'none';
                
                const current_track = state.track_window.current_track;
                
                if (current_track) {
                    let artistName = current_track.artists && current_track.artists.length > 0 ? 
                                    current_track.artists[0].name : 'Unknown Artist';
                    
                    let albumName = current_track.album && current_track.album.name ? 
                                   current_track.album.name : 'Unknown Album';
                                   
                    document.getElementById('track-info').innerHTML = `
                        <p><strong>Now Playing:</strong> ${current_track.name || 'Unknown Track'}</p>
                        <p><strong>Artist:</strong> ${artistName}</p>
                        <p><strong>Album:</strong> ${albumName}</p>
                    `;
                } else {
                    document.getElementById('track-info').innerHTML = '<p>No track information available</p>';
                }
                
                document.getElementById('play-button').textContent = state.paused ? 'Play' : 'Pause';
            });
            
            // Function to transfer playback to this device
            function transferPlayback(device_id) {
                fetch('https://api.spotify.com/v1/me/player', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        device_ids: [device_id],
                        play: false
                    })
                })
                .then(response => {
                    console.log('Transfer playback response status:', response.status);
                    
                    if (response.status === 204) {
                        console.log('Device transfer successful');
                        return;
                    }
                    
                    if (!response.ok) {
                        return response.text().then(text => {
                            console.error('Error transferring playback:', text);
                            throw new Error('Failed to transfer playback');
                        });
                    }
                })
                .catch(error => {
                    console.error('Transfer playback error:', error);
                    document.getElementById('connection-status').textContent = 'Error transferring playback: ' + error.message;
                });
            }
            
            // Function to start playback
            function startPlayback() {
                if (!deviceId) {
                    console.error('No device ID available');
                    return;
                }
                
                fetch('https://api.spotify.com/v1/me/player/play?device_id=' + deviceId, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    // You can optionally specify what to play
                    // body: JSON.stringify({
                    //     uris: ["spotify:track:7xGfFoTpQ2E7fRF5lN10tr"]
                    // })
                })
                .then(response => {
                    console.log('Play response status:', response.status);
                    
                    if (response.status === 204) {
                        console.log('Playback started successfully');
                        return; 
                    }
                    
                    if (!response.ok) {
                        return response.text().then(text => {
                            console.error('Error starting playback:', text);
                            document.getElementById('connection-status').textContent = 'Error starting playback. Try playing something in Spotify first.';
                            throw new Error('Failed to start playback');
                        });
                    }
                })
                .catch(error => {
                    console.error('Start playback error:', error);
                });
            }
            
            // Connect to the player
            player.connect()
            .then(success => {
                if (success) {
                    console.log('The Web Playback SDK successfully connected to Spotify!');
                } else {
                    console.error('The Web Playback SDK failed to connect to Spotify.');
                    document.getElementById('connection-status').textContent = 'Failed to connect to Spotify.';
                }
            });
            
            // Add event listeners for buttons
            document.getElementById('play-button').addEventListener('click', async () => {
                const state = await player.getCurrentState();
                if (!state) {
                    console.log('No active playback');
                    document.getElementById('connection-status').textContent = 'No active playback';
                    document.getElementById('start-playback').style.display = 'block';
                    return;
                }
                
                if (state.paused) {
                    player.resume();
                } else {
                    player.pause();
                }
            });
            
            document.getElementById('previous-button').addEventListener('click', () => {
                player.previousTrack();
            });
            
            document.getElementById('next-button').addEventListener('click', () => {
                player.nextTrack();
            });
            
            document.getElementById('start-playback-button').addEventListener('click', () => {
                startPlayback();
            });
        };
    </script>
</body>
</html>